---
title: "Exposure Trajectories Preliminary Analyses"
author: "Crystal Shaw"
output: 
  html_document:
    toc: true
    toc_float: 
      collapsed: no
    toc_depth: 4
    theme: journal
    highlight: zenburn
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r load packages}
if (!require("pacman")){
  install.packages("pacman", repos='http://cran.us.r-project.org')
}

p_load("here", "readr", "tidyverse", "magrittr", "plyr", "knitr", "broom")

#No scientific notation
options(scipen = 999)
```

```{r source scripts}
source(here::here("RScripts", "read_da_dct.R"))
source(here::here("RScripts", "non_missing.R"))
```

```{r read in data}
#2016 tracker file
hrs_tracker <- 
  read_da_dct("/Users/CrystalShaw/Box/HRS/2016_tracker/trk2016/TRK2016TR_R.da", 
              "/Users/CrystalShaw/Box/HRS/2016_tracker/trk2016/TRK2016TR_R.dct", 
              HHIDPN = TRUE)

#2006-2012 biomarker data
years <- c("06", "08", "10", "12")

for(year in years){
  assign(paste0("biomarker_", year), 
         read_da_dct(paste0("/Users/CrystalShaw/Box/HRS/biomarker_data/biomkr", 
                            year, "/BIOMK", year, "BL_R.da"),
                     paste0("/Users/CrystalShaw/Box/HRS/biomarker_data/biomkr", 
                            year, "/BIOMK", year, "BL_R.dct"), HHIDPN = TRUE))
}

#2014 early release biomarker data 
biomarker_14 <- 
  read_da_dct(
    "/Users/CrystalShaw/Box/HRS/biomarker_data/BIOMK14BL/BIOMK14BL.da",
    "/Users/CrystalShaw/Box/HRS/biomarker_data/BIOMK14BL/BIOMK14BL.dct", 
    HHIDPN = TRUE)
```

```{r pulling variables}
#We also want their age, sex, race/ethnicity, data to fill in mortality

hrs_samp <- hrs_tracker %>% 
  #participated in HRS 2014 wave (wave "O")
  filter(OIWTYPE == 1) %>% 
  select("HHIDPN", "OIWTYPE", "OAGE", "GENDER", 
         "RACE", "HISPANIC", "KNOWNDECEASEDMO", "KNOWNDECEASEDYR", "EXDEATHMO", 
         "EXDEATHYR", "OALIVE") 
```

```{r DOD}
#---- Deriving Date of Death (DOD) ----
# #Looking at values for each variable
# table(hrs_samp$KNOWNDECEASEDMO, useNA = "ifany")
# table(hrs_samp$KNOWNDECEASEDYR, useNA = "ifany")
# table(hrs_samp$OALIVE, useNA = "ifany")

#Translated from TMM SAS code
hrs_samp %<>% 
  mutate("DOD" = 
           case_when(!(KNOWNDECEASEDMO %in% c(0, 98, NA)) & 
                       !(KNOWNDECEASEDYR %in% c(0, 98, NA)) ~ 
                       paste0(KNOWNDECEASEDMO, "1", KNOWNDECEASEDYR), 
                     TRUE & !is.na(EXDEATHMO) & !is.na(EXDEATHYR) ~ 
                       paste0(EXDEATHMO, "1", EXDEATHYR), 
                     TRUE & OALIVE == 5 ~ "612015")) %>% 
  #died within wave
  mutate("death" = ifelse(is.na(DOD), 0, 1))

# #---- Sanity Check ----
# #Checking that assignments make sense
# #Checking assignments under first condition: No missing values in this group
# test_1 <- hrs_samp %>% 
#   filter(!(KNOWNDECEASEDMO %in% c(0, 98, NA)) & 
#            !(KNOWNDECEASEDYR %in% c(0, 98, NA))) 
# #There is data in this group
# nrow(test_1) 
# #none of these are empty 
# sum(!is.na(test_1$DOD))
# 
# #Checking assignments under second condition: No data in this group
# test_2 <- hrs_samp %>% 
#   filter(KNOWNDECEASEDMO %in% c(0, 98, NA) & 
#            KNOWNDECEASEDYR %in% c(0, 98, NA)) %>%
#   filter(!is.na(EXDEATHMO) & !is.na(EXDEATHYR)) 
# #There is no data in this group
# nrow(test_2) 
# 
# #Checking assignments under third condition: 
# test_oalive_1 <- hrs_samp %>% 
#   filter(KNOWNDECEASEDMO %in% c(0, 98, NA) & 
#            KNOWNDECEASEDYR %in% c(0, 98, NA)) %>%
#   filter(is.na(EXDEATHMO) | is.na(EXDEATHYR)) %>%
#   filter(OALIVE == 1) 
# #There is data in this group
# nrow(test_oalive_1) 
# #all of these are empty (OALIVE == 1 --> alive at wave)
# sum(!is.na(test_oalive_1$DOD))
# 
# #none of these are empty (OALIVE == 5 --> death reported in wave)
# test_oalive_5 <- hrs_samp %>% 
#   filter(KNOWNDECEASEDMO %in% c(0, 98, NA) & 
#            KNOWNDECEASEDYR %in% c(0, 98, NA)) %>%
#   filter(is.na(EXDEATHMO) | is.na(EXDEATHYR)) %>%
#   filter(OALIVE == 5)
# #There is no data in this group
# nrow(test_oalive_5) 
```

```{r age}
# #Sanity Check
# sum(hrs_samp$OAGE)
# hist(hrs_samp$OAGE)
```

```{r gender}
hrs_samp %<>% 
  mutate("female" = ifelse(GENDER == 2, 1, 0))

# #Sanity check
# table(hrs_samp$female, hrs_samp$GENDER)
```

```{r race-eth}
#Code any hispanic as 1, else 0
hrs_samp %<>% mutate("hispanic" = ifelse(HISPANIC %in% c(1, 2, 3), 1, 0)) %>% 
  mutate("black" = ifelse(RACE == 2 & hispanic == 0, 1, 0)) %>% 
  mutate("other" = ifelse(RACE == 7 & hispanic == 0, 1, 0)) %>% 
  mutate("unknown_race_eth" = ifelse(RACE == 0 & hispanic == 0, 1, 0))

# #Sanity check
# table(hrs_samp$hispanic, hrs_samp$HISPANIC)
# table(hrs_samp$hispanic, hrs_samp$RACE, hrs_samp$black)
# table(hrs_samp$hispanic, hrs_samp$RACE, hrs_samp$other)
# table(hrs_samp$hispanic, hrs_samp$RACE, hrs_samp$unknown_race_eth)

#There are 14 people missing race/ethnicity data so I am dropping them
hrs_samp %<>% filter(unknown_race_eth == 0) %>% 
  #Drop the HRS HISPANIC variable (recoded as hispanic)
  dplyr::select(-one_of("HISPANIC"))
```

```{r merge biomarker data}
analytic_df <- join_all(list(hrs_samp, biomarker_06, biomarker_08, 
                          biomarker_10, biomarker_12, biomarker_14), 
                     by = "HHIDPN", type = "left") %>% 
  #Select variables of interest
  dplyr::select(colnames(hrs_samp), contains("CYSC"))
```

```{r CYSC measures}
#average of all available CYSC measures
analytic_df[, "avg_CYSC"] <- 
  analytic_df %>% 
  dplyr::select(contains("CYSC_ADJ")) %>% 
  rowMeans(na.rm = TRUE)
#change NaN to NA for individuals with no measures of CYSC
analytic_df$avg_CYSC[is.nan(analytic_df$avg_CYSC)] <- NA
#z score the measures
analytic_df[, "avg_CYSC_zscore"] <- 
  (analytic_df$avg_CYSC - mean(analytic_df$avg_CYSC, na.rm = TRUE))/
  sd(analytic_df$avg_CYSC, na.rm = TRUE)

#last CYSC measure
analytic_df[, "last_CYSC"] <- 
  analytic_df %>% 
  dplyr::select(contains("CYSC_ADJ")) %>% 
  apply(., 1, function(x) non_missing(x, first = FALSE))
#z score the measures
analytic_df[, "last_CYSC_zscore"] <- 
  (analytic_df$last_CYSC - mean(analytic_df$last_CYSC, na.rm = TRUE))/
  sd(analytic_df$last_CYSC, na.rm = TRUE)

# #Sanity Check
# View(analytic_df %>% 
#        dplyr::select(c(contains("CYSC_ADJ"), "avg_CYSC", "last_CYSC")))
```

### Overview
Exposure: Cystatin C  
Outcome: Mortality

Question for preliminary analysis:
Conditional on participation in the 2014 HRS core interview, what is the association between Cystatin C and mortality after adjusting for age, gender, race/ethnicity?

Brief description of Cystatin C: "Cystatin C is a protein produced by all human cells, used primarily as a marker of kidney function. Levels of Cystatin C appear to rise with healthy aging, but elevated levels can also be indicative of serious cardiovascular disease and impending mortality, perhaps independently of kidney functioning." 

*It's good for this biomarker analysis that Cystatin C is thought to rise with healthy aging (in addition to being an indicator of kidney functioning and CVD).*

### List of Summary Stats

- Sample characteristics
- Number of Cystatin C measures per person
- Distribution of number of years between first and last measure
- Types of patterns

```{r sample characteristics}

```
#### Sample characteristics

#### CYSC measures/person
I am using the variable [wave]CYSC_ADJ for individuals based on the recommendation in the biomarker documentation to use the "NHANES equivalent values". Units for Cystatin C are mg/L. Based on my very brief lit review, it looks like Cystatin C is untransformed and used in logistic models in the medical literature so that's what I did for this preliminary analysis.

```{r CysC per person, out.width = "75%", fig.align = "center"}
analytic_df[, "num_measures"] <- 5 - (
  analytic_df %>% 
  dplyr::select(contains("CYSC_ADJ")) %>% is.na(.) %>% rowSums())

analytic_df$num_measures <- as.factor(analytic_df$num_measures)

# #Sanity Check
# View(analytic_df %>% dplyr::select(contains("CYSC_ADJ"), "num_measures"))

ggplot(analytic_df, aes(x = num_measures)) + 
  geom_bar(aes(y = ..count../sum(..count..), fill = factor(..x..)), 
           stat = "count", width = 0.3) +
  geom_text(aes(label = scales::percent(round(..count../sum(..count..), 2)),
                y = ..count../sum(..count..) ), stat = "count", vjust = -.5) +
  labs(y = "Percent", x = "Number of CysC Measures") +
  scale_y_continuous(labels = scales::percent) + 
  theme_minimal() + 
  theme(legend.position = "none")
```

#### FU time

#### CYSC patterns

### Models

#### Mortality on Avg CYSC

$$death \sim OAGE + female + hispanic + black + other + avgCYSC$$

*Note that the estimates are the ORs from the model. 

```{r avg value model}
model_avg_cysc <- 
  glm(death ~ OAGE + female + hispanic + black + other + avg_CYSC, 
      family = binomial(link = "logit"), data = analytic_df)

kable(tidy(model_avg_cysc, exponentiate = TRUE))


# #Checking model fit
# pchisq(model_avg_cysc$deviance, df = model_avg_cysc$df.residual, lower.tail = F)
# plot(model_avg_cysc)
```


#### Mortality on Last CYSC

$$death \sim OAGE + female + hispanic + black + other + lastCYSC$$

*Note that the estimates are the ORs from the model.  

```{r last value model}
model_last_cysc <- 
  glm(death ~ OAGE + female + hispanic + black + other + last_CYSC, 
      family = binomial(link = "logit"), data = analytic_df)

kable(tidy(model_last_cysc, exponentiate = TRUE))

# #Checking model fit
# pchisq(model_last_cysc$deviance, df = model_last_cysc$df.residual, 
#        lower.tail = F)
# plot(model_last_cysc)
```


#### Mortality on First CYSC