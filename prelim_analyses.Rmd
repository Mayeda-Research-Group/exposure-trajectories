---
title: "Exposure Trajectories Preliminary Analyses"
author: "Crystal Shaw"
output: 
  html_document:
    toc: true
    toc_float: 
      collapsed: no
    toc_depth: 5
    theme: journal
    highlight: zenburn
    code_folding: hide
bibliography: /Users/CrystalShaw/Dropbox/Mendeley Bibtex/Exposure Trajectories.bib
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r load packages}
if (!require("pacman")){
  install.packages("pacman", repos='http://cran.us.r-project.org')
}

p_load("here", "tidyverse", "magrittr", "knitr", "broom", "kableExtra", "lme4")

#No scientific notation
options(scipen = 999)
```

### Overview
Exposure: Cystatin C  
Outcome: Mortality

Question for preliminary analysis:
Conditional on participation in the 2014 HRS core interview, what is the association between Cystatin C and mortality after adjusting for age, gender, race/ethnicity?

Brief description of Cystatin C: "Cystatin C is a protein produced by all human cells, used primarily as a marker of kidney function. Levels of Cystatin C appear to rise with healthy aging, but elevated levels can also be indicative of serious cardiovascular disease and impending mortality, perhaps independently of kidney functioning." 

*It's good for this biomarker analysis that Cystatin C is thought to rise with healthy aging (in addition to being an indicator of kidney functioning and CVD).*

```{r read in data}
hrs_samp <- read_csv(here::here("Data", "hrs_samp.csv"))
analytic_df <- read_csv(here::here("Data", "analytic_df.csv"))
```

### List of Summary Stats

- Sample characteristics
- Number of Cystatin C measures per person
- Distribution of number of years between first and last measure
- Types of patterns

```{r flow diagram, fig.align = "center", out.width = "35%"}
knitr::include_graphics(here::here("Figures", "flow_diagram.png"))
```

```{r sample characteristics at wave O}

```
#### Sample characteristics

#### Number CysC measures

```{r CysC by wave}
CYSC_bywave <- analytic_df %>% dplyr::select(contains("CYSC_ADJ")) %>% 
  apply(2, function(x) !is.na(x)) %>% colSums() %>% as.data.frame() %>% 
  set_colnames(c("Count")) %>% 
  mutate("Proportion of <br>2014 HRS sample" = 
           round(Count/nrow(analytic_df), 2)) %>% 
  rownames_to_column(var = "long_name") %>% 
  mutate("Wave" = substr(long_name, start = 1, stop = 1)) %>% 
  mutate("Year" = c("2006", "2008", "2010", "2012", "2014")) %>%
  dplyr::select("Wave", "Year", "Count", "Proportion of <br>2014 HRS sample")

kable(CYSC_bywave, align = "c", escape = FALSE) %>% 
  kable_styling(full_width = FALSE)
```

#### CysC measures/person
I am using the variable [wave]CYSC_ADJ for individuals based on the recommendation in the biomarker documentation to use the "NHANES equivalent values". Units for Cystatin C are mg/L. Based on my very brief lit review, it looks like raw Cystatin C data (untransformed) is used as a predictor in regression models in the medical literature so that's what I did for this preliminary analysis.  

In this preliminary analysis, Cystatin C measures are used for those who participated in the 2014 wave of HRS (core interview) only. 

```{r CysC per person, out.width = "75%", fig.align = "center"}
analytic_df[, "num_measures"] <- 5 - (
  analytic_df %>% 
  dplyr::select(contains("CYSC_ADJ")) %>% is.na(.) %>% rowSums())

analytic_df$num_measures <- as.factor(analytic_df$num_measures)

# #Sanity Check
# test_no_measures <- analytic_df %>% 
#   dplyr::select(contains("CYSC_ADJ")) %>% is.na(.) %>% rowSums()
# table(test_no_measures)
# table(test_no_measures)/sum(table(test_no_measures))
# hist(analytic_df$KCYSC_ADJ)
# table(analytic_df$KCYSC_ADJ, useNA = "ifany")
# View(analytic_df %>% dplyr::select(contains("CYSC_ADJ"), "num_measures"))

ggplot(analytic_df, aes(x = num_measures)) + 
  geom_bar(aes(y = ..count../sum(..count..), fill = factor(..x..)), 
           stat = "count", width = 0.3) +
  geom_text(aes(label = scales::percent(round(..count../sum(..count..), 2)),
                y = ..count../sum(..count..) ), stat = "count", vjust = -.5) +
  labs(y = "Percent", x = "Number of CysC Measures") +
  scale_y_continuous(labels = scales::percent) + 
  theme_minimal() + 
  theme(legend.position = "none")
```

#### FU time
What is the distribution of time between first and last Cystatin C measure? These values are based on the participant's age during the interview waves (or imputed age if they didn't participate in the wave). I imputed age by subtracting back from their Wave O age since everyone has an age at Wave O.

*Note that those who only have 1 Cystatin C measure have 0 years of follow up

```{r FU time, out.width = "75%", fig.align = "center"}
analytic_df$fu_time <- as.factor(analytic_df$fu_time)

ggplot(analytic_df, aes(x = fu_time)) + 
  geom_bar(aes(y = ..count../sum(..count..), fill = factor(..x..)), 
           stat = "count", width = 0.3) +
  geom_text(aes(label = scales::percent(round(..count../sum(..count..), 2)),
                y = ..count../sum(..count..) ), stat = "count", vjust = -.5) +
  labs(y = "Percent", x = "Length of Follow-up") +
  scale_y_continuous(labels = scales::percent) + 
  theme_minimal() + 
  theme(legend.position = "none")
```

#### CysC patterns
Looking at the different patterns and distributions for the CysC measures

```{r wide to long}
columns_to_pick <- 
  colnames(analytic_df)[str_detect(colnames(analytic_df), "CYSC_ADJ")]
  
analytic_df_long <- pivot_longer(analytic_df, all_of(columns_to_pick), 
                                 names_to = "long_name") %>% 
  mutate("Wave" = substr(long_name, start = 1, stop = 1)) %>% 
  mutate("Year" = case_when(Wave == "K" ~ "2006", 
                            Wave == "L" ~ "2008", 
                            Wave == "M" ~ "2010", 
                            Wave == "N" ~ "2012", 
                            Wave == "O" ~ "2014"))

#Create categorical variables for plotting
analytic_df_long %<>% 
  mutate("gender_cat" = ifelse(female == 1, "Women", "Men")) %>%
  mutate("race_eth_cat" = case_when(black == 1 ~ "Black", 
                                    hispanic == 1 ~ "Hispanic", 
                                    other == 1 ~ "Other",
                                    TRUE ~ "White"))

#Data for plots
df_plots <- analytic_df_long %>% 
  #drop anyone without any CysC measures
  filter(num_measures != 0) %>% 
  #drop gender variable for waves without measures
  mutate("gender_cat" = ifelse(is.na(value), NA, gender_cat)) %>%
  #drop race/ethnicity variable for waves without measures
  mutate("race_eth_cat" = ifelse(is.na(value), NA, race_eth_cat))

# #Sanity Check
# table(analytic_df_long$gender_cat, analytic_df_long$female)
```

##### Sex/Gender distributions

```{r sex dist by wave, out.width = "75%", fig.align = "center"}
plot_data <- df_plots %>% filter(!is.na(gender_cat))
ggplot(plot_data, aes(x = gender_cat)) + 
  geom_bar(aes(y = ..count.., fill = factor(..x..)), 
           stat = "count", width = 0.3) + 
  theme_bw() + theme(legend.position = "none") + facet_wrap("Year") + 
  labs(y = "Count", x = "Sex/Gender") 

# #Sanity Check
# test_df <- df_plots %>% filter(Wave == "L")
# table(test_df$gender_cat)
```

##### Age distributions 
```{r age}
#How many people are missing at least one age value?
people_age_miss <- hrs_samp %>% dplyr::select(contains("AGE")) %>% 
  apply(., 1, function(x) 999 %in% x) %>% sum()

num_age_miss <- hrs_samp %>% dplyr::select(contains("AGE")) 
num_age_miss <- sum(num_age_miss == 999)
```

There are `r format(people_age_miss, big.mark = ",")` people with at least one imputed age (`r round(people_age_miss/nrow(analytic_df)*100, 2)`%).  

There are a total of `r format(num_age_miss, big.mark = ",")` imputed ages (`r round(num_age_miss/(nrow(analytic_df)*5)*100, 2)`%).  

I imputed age by subtracting back (2yrs/wave) from participants' Wave O (2014 wave) age since everyone has an age at that wave (this analysis is conditional on participation in the 2014 wave).  This imputation will be done using birth month/year and interview month/year in the future.

```{r age dist by wave, out.width = "75%", fig.align = "center"}
data <- df_plots %>% dplyr::select("HHIDPN", contains("AGE"), "value") %>%
  filter(!is.na(value)) %>% distinct(., HHIDPN, .keep_all = TRUE)

plot_data <- pivot_longer(data, contains("AGE"), names_to = "long_name", 
                          values_to = "Age") %>% 
  mutate("Wave" = substr(long_name, start = 1, stop = 1)) %>% 
  mutate("Year" = case_when(Wave == "K" ~ "2006", 
                            Wave == "L" ~ "2008", 
                            Wave == "M" ~ "2010", 
                            Wave == "N" ~ "2012", 
                            Wave == "O" ~ "2014"))

ggplot(plot_data, aes(x = Age)) + 
  #This is a trick; you could put any text here to get this color
  geom_histogram(aes(fill = "coral")) + 
  theme_bw() + theme(legend.position = "none") + facet_wrap("Year") + 
  labs(y = "Count", x = "Age")
```

##### Race/Ethnicity distributions

```{r race/eth dist by wave, out.width = "75%", fig.align = "center"}
plot_data <- df_plots %>% filter(!is.na(race_eth_cat))
ggplot(plot_data, aes(x = race_eth_cat)) + 
  geom_bar(aes(y = ..count.., fill = factor(..x..)), 
           stat = "count", width = 0.3) + 
  theme_bw() + theme(legend.position = "none") + facet_wrap("Year") + 
  labs(y = "Count", x = "Race/Ethnicity") 
```

### Is CysC associated with mortality?  

Percent mortality: `r round(mean(analytic_df$death)*100, 2)`%  

Distributions of Cystatin C measures used in each model:

```{r Cystatin C dists, out.width = "75%", fig.align = "center"}
plot_data <- analytic_df %>% dplyr::select("avg_CYSC", "last_CYSC") %>% 
  pivot_longer(cols = c("avg_CYSC", "last_CYSC"), names_to = "Measure", 
               values_to = "Cystatin C")
plot_data$Measure <- str_remove(plot_data$Measure, "_CYSC")
  
ggplot(data = plot_data, aes(x = Measure, y = `Cystatin C`)) + 
  geom_boxplot(color = "#FF766D") + 
  theme_minimal()
```

Correlation between age at 2014 HRS wave and age at last CysC measure (line produced by loess smoothing):

```{r age correlations, out.width = "75%", fig.align = "center"}
# Loess method
ggplot(analytic_df, aes(x = last_CYSC_age, y = OAGE)) + 
  geom_point(colour = "#737C87") +
  geom_smooth(colour = "#F8766D") + 
  theme_minimal() + 
  xlab("Age at last CysC measure") + ylab("Age at 2014 HRS Wave")
```

#### CysC on Age

```{r CysC on Age, out.width = "75%", fig.align = "center"}
plot_data <- analytic_df %>% dplyr::select(contains("AGE", ignore.case = FALSE),
                                           contains("_ADJ")) %>% 
  set_colnames(c(paste0("x", seq(1:5)), 
                 paste0("y", seq(1:5)))) %>%
  pivot_longer(everything(), names_to = c(".value", "set"), 
               names_pattern = "(.)(.)")

ggplot(plot_data, aes(x, y)) +
  geom_point(colour = "#737C87") +
  #Span in the fraction of points used to fit each local regression
  geom_smooth(colour = "#F8766D", span = 0.001) + 
  xlab("Age at CysC measure") + ylab("CysC (mg/L)") +
  theme_minimal()
```

#### Mortality on Avg CysC  

$$death \sim OAGE + female + hispanic + black + other + avgCYSC$$

*Note that the estimates are the ORs from the model. 

```{r avg value model}
model_avg_cysc <- 
  glm(death ~ OAGE + female + hispanic + black + other + avg_CYSC, 
      family = binomial(link = "logit"), data = analytic_df)

kable(tidy(model_avg_cysc, exponentiate = TRUE)) %>% 
  kable_styling(full_width = TRUE)

# #Checking model fit
# pchisq(model_avg_cysc$deviance, df = model_avg_cysc$df.residual, lower.tail = F)
# plot(model_avg_cysc)
```


#### Mortality on Last CysC

$$death \sim OAGE + female + hispanic + black + other + lastCYSC$$

*Note that the estimates are the ORs from the model.  

```{r last value model}
model_last_cysc <- 
  glm(death ~ OAGE + female + hispanic + black + other + last_CYSC, 
      family = binomial(link = "logit"), data = analytic_df)

kable(tidy(model_last_cysc, exponentiate = TRUE)) %>% 
  kable_styling(full_width = TRUE)

# #Checking model fit
# pchisq(model_last_cysc$deviance, df = model_last_cysc$df.residual, 
#        lower.tail = F)
# plot(model_last_cysc)
```

### Imputation
In order to impute missing values of Cystatin C, we need predictors of this outcome. According to an analysis by @Knight2004, age, sex/gender, weight, height, cigarette smoking, and C-Reactive Protein (CRP) levels were independently associated with Cystatin C levels after adjusting for creatinine clearance (a biomarker often used to classify poor renal function and one that Cystatin C has been proposed to replace). @Wei2014 found that in elderly populations, BMI, nephritis, kidney neoplasm, and hypertension were associated with levels of Cystatin C. Both analyses used the log of CysC. 

*Neither of these sources mention race/ethnicity, but we will adjust for it anyway.*

I'm thinking that we don't want a model that controls for CRP even though it's available in the HRS biomarker data.  This is likely to have just as much missing data as Cystatin C, so we would need an imputation for this biomarker as well.

I'm going to start with a simple model for Cystatin C that controls for age sex/gender, and race/ethnicity just to see how this works. 

#### Assessing LMM fit

\begin{align*}
log(CysC) \sim Age &+ female + hispanic + black + other + \\
&female*Age + hispanic*Age + black*Age + other*Age + (1|HHIDPN)
\end{align*}

```{r wide --> long}
long_df <- analytic_df %>% 
  dplyr::select("HHIDPN", "female", "hispanic", "black", "other", 
                contains("AGE", ignore.case = FALSE), contains("CYSC_ADJ")) %>% 
  pivot_longer(cols = c(contains("AGE"), contains("CYSC_ADJ")), 
               names_to = c("wave", ".value"), 
               names_pattern = "(.)(.)") %>% 
  set_colnames(c("HHIDPN", "female", "hispanic", "black", "other", "wave", 
                 "Age", "CYSC"))

long_df[, "log_CYSC"] <- log(long_df$CYSC)
```

```{r Cys C dists, out.width = "75%", fig.align = "center"}
plot_data <- long_df[, c("CYSC", "log_CYSC")] %>% 
  pivot_longer(everything(), names_to = "Measure", 
               values_to = "Value")
  
ggplot(data = plot_data, aes(x = Measure, y = Value)) + 
  geom_boxplot(color = "#FF766D") + 
  theme_minimal()
```

```{r lmm model}
#Model with random intercept for HHIDPN
lmm1 <- lmer(log_CYSC ~ female + hispanic + black + other + Age + 
               female*Age + hispanic*Age + black*Age + other*Age + 
               (1|HHIDPN), 
             data = long_df)

kable(tidy(lmm1)) %>% kable_styling(full_width = TRUE)
```

#### Model Diagnostics {.tabset}

##### Fitted vs. Residuals
```{r tab1}
plot(lmm1, xlab = "Fitted values", ylab = "Residuals", col = "#F8766D" )
```

##### Dist. of Residuals
```{r tab2}
hist(resid(lmm1))
```

##### Q-Q Plot
```{r tab3}
qqnorm(resid(lmm1))
qqline(resid(lmm1))
```

#### {-}

#### Single imputation with LMM 


### References